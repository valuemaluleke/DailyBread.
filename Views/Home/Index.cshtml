@using DailyBread.Models
@model VerseViewModel

@{
    ViewData["Title"] = "Daily Bread";
    var currentFeeling = ViewData["UserFeeling"] as string;
    var streak = ViewBag.Streak ?? 1;
    var dailyPrayer = ViewBag.Prayer as string;
    var currentVersion = ViewBag.CurrentVersion as string;
    var missedDay = ViewBag.MissedDay as bool? ?? false;

    var shareText = $"🍞 Daily Bread: \"{Model.Text}\" - {Model.Reference} ({currentVersion.ToUpper()})";
    var whatsappUrl = $"https://wa.me/?text={Uri.EscapeDataString(shareText)}";
    var twitterUrl = $"https://twitter.com/intent/tweet?text={Uri.EscapeDataString(shareText)}";
}

<div class="container" style="position: relative;">
    
    <div class="d-flex justify-content-end align-items-center gap-2" style="position: absolute; top: 0; right: 0; margin-top: 10px;">
        
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-warning rounded-circle shadow-sm" type="button" id="reminderDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                <span id="bellIcon">🔔</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-3 shadow" style="width: 280px; border-radius: 15px;">
                <li><h6 class="dropdown-header">📅 Set Daily Reminder</h6></li>
                <li><small id="currentReminderStatus" class="text-muted ps-3">No reminder set.</small></li>
                <li><hr class="dropdown-divider"></li>
                <li><button onclick="setReminder('morning')" class="dropdown-item rounded">🌅 Morning (8:00 AM)</button></li>
                <li><button onclick="setReminder('afternoon')" class="dropdown-item rounded">☀️ Afternoon (12:00 PM)</button></li>
                <li><button onclick="setReminder('night')" class="dropdown-item rounded">🌙 Night (8:00 PM)</button></li>
                <li><hr class="dropdown-divider"></li>
                <li><button onclick="clearReminder()" class="dropdown-item rounded text-danger">🔕 Turn Off</button></li>
            </ul>
        </div>

        <form method="get" action="/" style="margin: 0;">
            <select name="translation" onchange="this.form.submit()" class="form-select form-select-sm shadow-sm" style="border-radius: 20px; cursor: pointer; width: auto;">
                <option value="web" selected="@(currentVersion == "web")">WEB (Modern)</option>
                <option value="kjv" selected="@(currentVersion == "kjv")">KJV (Classic)</option>
                <option value="bbe" selected="@(currentVersion == "bbe")">BBE (Simple)</option>
            </select>
        </form>

        <span class="badge rounded-pill bg-warning text-dark shadow-sm d-flex align-items-center" style="font-size: 1rem; padding: 8px 15px;">
            🔥 @streak
        </span>
    </div>

    @if (missedDay)
    {
        <div class="alert alert-warning shadow-sm text-center" role="alert" style="margin-top: 60px; border-radius: 15px; border-left: 5px solid #f59e0b;">
            <strong>Hey bestie 💛</strong> We missed you yesterday! Don’t forget your time with God today.
            <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="text-center" style="@(missedDay ? "margin-top: 20px;" : "margin-top: 60px;")">
        <h1 class="display-4">Risi's Daily Bread 🍞</h1>
        <p class="lead text-muted"> Daily dose of wisdom.</p>
        <hr />

        <div class="mood-selector" style="margin-bottom: 30px; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
            <form method="get" action="/" id="moodForm">
                <label style="font-weight: 600; color: #78716c; margin-bottom: 10px; display: block;">
                    How are you feeling right now?
                </label>
                <input type="text" name="userFeeling" class="form-control text-center" 
                       placeholder="e.g. Anxious about work..." value="@currentFeeling" 
                       style="max-width: 400px; margin: 0 auto 15px auto; border-radius: 20px;" />

                <div class="d-flex justify-content-center gap-2 flex-wrap mt-3">
                    <button type="submit" name="mood" value="anxious" class="btn btn-outline-dark btn-sm rounded-pill">😟 Anxious</button>
                    <button type="submit" name="mood" value="sad" class="btn btn-outline-dark btn-sm rounded-pill">😢 Sad</button>
                    <button type="submit" name="mood" value="grateful" class="btn btn-outline-dark btn-sm rounded-pill">🙏 Grateful</button>
                    <button type="submit" name="mood" value="hopeful" class="btn btn-outline-dark btn-sm rounded-pill">✨ Hopeful</button>
                    <a href="/" class="btn btn-outline-secondary btn-sm rounded-pill">🎲 Surprise Me</a>
                </div>
            </form>
        </div>

        <div class="card shadow-sm" style="margin: 0 auto 20px auto; max-width: 600px; padding: 20px;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="card-title text-primary mb-0">@Model.Reference</h2>
                    <div class="d-flex gap-2 align-items-center">
                        <button onclick="toggleSpeech()" id="audioBtn" class="btn btn-light btn-sm rounded-circle border">🔊</button>
                        <span class="badge bg-light text-secondary border">@currentVersion.ToUpper()</span>
                    </div>
                </div>
                <p class="card-text" style="font-size: 1.5rem; font-style: italic;">"@Model.Text"</p>
                
                <div class="d-flex justify-content-center gap-3 mt-4 pt-3 border-top">
                    <a href="@whatsappUrl" target="_blank" class="btn btn-sm btn-success rounded-pill" style="min-width: 100px;">💬 WhatsApp</a>
                    <a href="@twitterUrl" target="_blank" class="btn btn-sm btn-dark rounded-pill" style="min-width: 100px;">🐦 X / Tweet</a>
                    <button onclick="copyToClipboard()" class="btn btn-sm btn-outline-primary rounded-pill" style="min-width: 100px;">📋 Copy</button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0" style="margin: 0 auto 30px auto; max-width: 600px; background-color: #eff6ff; border-left: 5px solid #3b82f6 !important;">
            <div class="card-body text-start">
                <h5 style="color: #1e40af; font-weight: 700;">🙏 Prayer for Today</h5>
                <p class="mb-0" style="color: #1e3a8a; font-family: 'Merriweather', serif; font-style: italic;">"@dailyPrayer"</p>
            </div>
        </div>

        <div class="d-flex justify-content-center gap-3" style="margin-top: 20px;">
            <a href="/" class="btn btn-outline-dark btn-lg" style="height: 100%; display: flex; align-items: center;">✨ Give me Another  Verse</a>
            <form asp-action="SaveVerse" method="post" style="text-align: left; width: 300px;">
                <input type="hidden" asp-for="Reference" />
                <input type="hidden" asp-for="Text" />
                <div style="margin-bottom: 10px;">
                    <textarea name="userNote" class="form-control" placeholder="Write a personal note... (Optional)" rows="2">@currentFeeling</textarea>
                </div>
                <button type="submit" class="btn btn-danger w-100 btn-lg">❤️ Save to Journal</button>
            </form>
        </div>

        <br />

        <div class="row justify-content-center mt-5 g-4">
            
            <div class="col-auto">
                <a href="/Home/Favorites" class="card text-decoration-none shadow-sm h-100 border-0 nav-card" 
                   style="width: 140px; border-radius: 20px; transition: all 0.2s ease;">
                    <div class="card-body text-center d-flex flex-column justify-content-center align-items-center p-4">
                        <span style="font-size: 2.5rem; margin-bottom: 10px;">📂</span>
                        <span class="fw-bold text-dark">Journal</span>
                    </div>
                </a>
            </div>

            <div class="col-auto">
                <a href="/Home/PrayerWall" class="card text-decoration-none shadow-sm h-100 border-0 nav-card" 
                   style="width: 140px; border-radius: 20px; transition: all 0.2s ease;">
                    <div class="card-body text-center d-flex flex-column justify-content-center align-items-center p-4">
                        <span style="font-size: 2.5rem; margin-bottom: 10px;">🙏</span>
                        <span class="fw-bold text-dark">Prayers</span>
                    </div>
                </a>
            </div>

            <div class="col-auto">
                <a href="/Home/ReadingPlans" class="card text-decoration-none shadow-sm h-100 border-0 nav-card" 
                   style="width: 140px; border-radius: 20px; transition: all 0.2s ease;">
                    <div class="card-body text-center d-flex flex-column justify-content-center align-items-center p-4">
                        <span style="font-size: 2.5rem; margin-bottom: 10px;">📖</span>
                        <span class="fw-bold text-dark">Plans</span>
                    </div>
                </a>
            </div>

        </div>

        <style>
            .nav-card {
                background-color: #ffffff; 
            }
            .nav-card:hover {
                transform: translateY(-8px); /* Lifts up */
                box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important; /* Glow effect */
                background-color: #fffbeb; /* Slight warm tint */
            }
        </style>
    </div>
</div>

<script>
    // --- COPY FUNCTION ---
    function copyToClipboard() {
        var text = 'Daily Bread: "@Model.Text" - @Model.Reference (@currentVersion.ToUpper())';
        navigator.clipboard.writeText(text).then(function() { alert("Verse copied to clipboard! 📋"); });
    }

    // --- TEXT TO SPEECH ---
    let isSpeaking = false;
    function toggleSpeech() {
        const btn = document.getElementById('audioBtn');
        if (isSpeaking) { window.speechSynthesis.cancel(); isSpeaking = false; btn.innerText = "🔊"; }
        else {
            const text = "@Model.Reference" + ". " + "@Model.Text".replace(/&quot;/g, '');
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => v.name.includes("Zira") || v.name.includes("Google US English"));
            if (preferredVoice) utterance.voice = preferredVoice;
            utterance.onend = function() { isSpeaking = false; btn.innerText = "🔊"; };
            window.speechSynthesis.speak(utterance);
            isSpeaking = true;
            btn.innerText = "⏹️";
        }
    }

    // --- AUTOMATIC REMINDERS ---
    
    // 1. Run this when page loads to check if we have a saved reminder
    document.addEventListener('DOMContentLoaded', function() {
        var savedTime = localStorage.getItem('dailyReminderTime');
        if (savedTime) {
            console.log("Found saved reminder: " + savedTime);
            startTimer(savedTime);
            updateStatusText(savedTime);
        }
    });

    function setReminder(timeOfDay) {
        // Ask Permission first
        if (!("Notification" in window)) {
            alert("This browser does not support notifications");
            return;
        }

        Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
                // Save to Memory
                localStorage.setItem('dailyReminderTime', timeOfDay);
                
                // Start Timer
                startTimer(timeOfDay);
                updateStatusText(timeOfDay);
                alert("Reminder set for " + timeOfDay + "! ⏰ We'll remember this for tomorrow too.");
            }
        });
    }

    function clearReminder() {
        localStorage.removeItem('dailyReminderTime');
        updateStatusText(null);
        alert("Reminder turned off. 🔕");
    }

    function updateStatusText(timeOfDay) {
        var status = document.getElementById('currentReminderStatus');
        var bell = document.getElementById('bellIcon');
        
        if (timeOfDay) {
            status.innerHTML = "✅ Active: <strong>" + timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1) + "</strong>";
            status.className = "text-success ps-3";
            bell.innerText = "⏰"; // Change icon to clock
        } else {
            status.innerHTML = "No reminder set.";
            status.className = "text-muted ps-3";
            bell.innerText = "🔔";
        }
    }

    function startTimer(timeOfDay) {
        // Check time every 60 seconds
        setInterval(function() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();

            // Only fire at minute 0 (top of the hour)
            if (minutes === 0) {
                if (timeOfDay === 'morning' && hours === 8) showNotification();
                if (timeOfDay === 'afternoon' && hours === 12) showNotification();
                if (timeOfDay === 'night' && hours === 20) showNotification();
            }
        }, 60000); 
    }

    function showNotification() {
        var notification = new Notification("Risi's Daily Bread 🍞", {
            body: "Hey bestie 💛 Don’t forget your time with God today!",
            icon: "https://emojigraph.org/media/apple/bread_1f35e.png"
        });
    }
</script>